<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Регистрация</title>
  <style>
    /* same style as login for consistency */
    :root{--primary-dark:#30393E;--primary-light:#988F88;--background:#FAEFEB;--accent:#F8BD97;--secondary:#D5C1B6}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--background);margin:0;height:100vh;display:flex;align-items:center;justify-content:center;color:var(--primary-dark)}
    .auth-container{background:#fff;border-radius:15px;padding:30px;max-width:400px;width:100%;box-shadow:0 4px 10px rgba(0,0,0,.1)}
    .auth-header{text-align:center;margin-bottom:20px}.auth-title{margin:0 0 6px}.auth-subtitle{color:var(--primary-light);font-size:14px}
    .auth-form{display:flex;flex-direction:column;gap:16px}.input-group{display:flex;flex-direction:column;gap:6px}
    .input-group input{padding:10px;border:1px solid var(--secondary);border-radius:8px}
    .auth-btn{padding:12px;border-radius:8px;background:var(--primary-light);color:#fff;border:none;cursor:pointer}
    .auth-footer{text-align:center;margin-top:14px;color:var(--primary-light)}
    .error-message{color:#e74c3c;font-size:14px;display:none}
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1 class="auth-title">Создать аккаунт</h1>
      <p class="auth-subtitle">Заполните форму для регистрации</p>
    </div>

    <form id="signupForm" class="auth-form" autocomplete="off">
      <div class="input-group">
        <label for="username">Имя пользователя</label>
        <input id="username" type="text" required />
        <div id="usernameError" class="error-message"></div>
      </div>

      <div class="input-group">
        <label for="email">Email</label>
        <input id="email" type="email" required />
        <div id="emailError" class="error-message"></div>
      </div>

      <div class="input-group">
        <label for="password">Пароль</label>
        <input id="password" type="password" required />
        <div class="password-requirements">Минимум 8 символов</div>
        <div id="passwordError" class="error-message"></div>
      </div>

      <div class="input-group">
        <label for="confirmPassword">Подтвердите пароль</label>
        <input id="confirmPassword" type="password" required />
        <div id="confirmPasswordError" class="error-message"></div>
      </div>

      <button type="submit" class="auth-btn">Зарегистрироваться</button>
    </form>

    <div class="auth-footer">
      Уже есть аккаунт? <a href="/login">Войдите</a>
    </div>
  </div>

  <script>
    // EDIT: set Chat exchange endpoint to your Chat service
    const CHAT_EXCHANGE_URL = "https://localhost:8080/chat/exchange";
    const AUTH_SIGNUP_URL = "/api/signup";

    function showError(msg, elId) {
      if (elId) {
        const el = document.getElementById(elId);
        el.textContent = msg; el.style.display = 'block';
        return;
      }
      alert(msg);
    }

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (password !== confirm) { showError('Пароли не совпадают', 'confirmPasswordError'); return; }
      if (password.length < 8) { showError('Пароль должен быть не менее 8 символов', 'passwordError'); return; }

      try {
        // 1) create user at Auth
        const res = await fetch(AUTH_SIGNUP_URL, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password })
        });

        const json = await res.json();
        if (!res.ok) { showError(json.Error || json.error || "Ошибка регистрации"); return; }

        const accessToken = json.AccessToken || json.access_token;
        if (!accessToken) { showError("Нет access token в ответе от сервера"); return; }

        // 2) call Chat exchange with Authorization header
        const exchangeRes = await fetch(CHAT_EXCHANGE_URL, {
          method: "POST",
          credentials: "include",
          headers: {
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({})
        });

        if (!exchangeRes.ok) {
          const er = await exchangeRes.json().catch(()=>({}));
          showError(er.Error || er.error || "Ошибка связи с Chat");
          return;
        }

        // 3) redirect to chat UI
        window.location.href = (new URL(CHAT_EXCHANGE_URL)).origin + "/";

      } catch (err) {
        console.error(err);
        showError("Ошибка сети");
      }
    });
  </script>
</body>
</html>