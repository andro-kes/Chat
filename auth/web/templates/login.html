<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход в систему</title>
  <style>
    /* (same CSS as your original; kept compact for readability) */
    :root{--primary-dark:#30393E;--primary-light:#988F88;--background:#FAEFEB;--accent:#F8BD97;--secondary:#D5C1B6}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--background);margin:0;height:100vh;display:flex;align-items:center;justify-content:center;color:var(--primary-dark)}
    .auth-container{background:#fff;border-radius:15px;padding:30px;max-width:400px;width:100%;box-shadow:0 4px 10px rgba(0,0,0,.1)}
    .auth-header{text-align:center;margin-bottom:20px}.auth-title{margin:0 0 6px}.auth-subtitle{color:var(--primary-light);font-size:14px}
    .auth-form{display:flex;flex-direction:column;gap:16px}.input-group{display:flex;flex-direction:column;gap:6px}
    .input-group input{padding:10px;border:1px solid var(--secondary);border-radius:8px}
    .auth-btn{padding:12px;border-radius:8px;background:var(--primary-light);color:#fff;border:none;cursor:pointer}
    .auth-footer{text-align:center;margin-top:14px;color:var(--primary-light)}
    .error-message{color:#e74c3c;font-size:14px;display:none}
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1 class="auth-title">Вход в аккаунт</h1>
      <p class="auth-subtitle">Введите свои данные для входа</p>
    </div>

    <form id="loginForm" class="auth-form" autocomplete="off">
      <div class="input-group">
        <label for="email">Email</label>
        <input id="email" type="email" required />
        <div id="emailError" class="error-message"></div>
      </div>

      <div class="input-group">
        <label for="password">Пароль</label>
        <input id="password" type="password" required />
        <div id="passwordError" class="error-message"></div>
      </div>

      <button type="submit" class="auth-btn">Войти</button>
    </form>

    <div class="auth-footer">
      Нет аккаунта? <a href="/signup_page">Зарегистрируйтесь</a>
    </div>
  </div>

  <script>
    // EDIT THIS: the absolute URL to your Chat exchange endpoint
    const CHAT_EXCHANGE_URL = "https://localhost:8080/chat/exchange";
    // AUTH endpoints are relative here; if auth is on another domain, use full URL.
    const AUTH_LOGIN_URL = "/api/login";

    function showError(msg, elId) {
      if (elId) {
        const el = document.getElementById(elId);
        el.textContent = msg; el.style.display = 'block';
        return;
      }
      alert(msg);
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // clear previous errors
      document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      try {
        // 1) Send credentials to Auth. credentials: 'include' so browser accepts HttpOnly cookies set by Auth.
        const res = await fetch(AUTH_LOGIN_URL, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const json = await res.json();

        if (!res.ok) {
          showError(json.Error || json.error || "Ошибка входа");
          return;
        }

        // 2) Auth returns access_token in JSON (handlers do this). Use it to call Chat exchange via Authorization header.
        const accessToken = json.AccessToken || json.access_token;
        if (!accessToken) {
          showError("Нет access token в ответе от сервера");
          return;
        }

        const exchangeRes = await fetch(CHAT_EXCHANGE_URL, {
          method: "POST",
          credentials: "include", // allow chat to set its own cookie/session
          headers: {
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({}) // body optional — your exchange handler may not need it
        });

        if (!exchangeRes.ok) {
          const er = await exchangeRes.json().catch(()=>({}));
          showError(er.Error || er.error || "Ошибка соединения с Chat");
          return;
        }

        // 3) successful — navigate to chat UI root
        // If Chat lives on another domain, use that full URL.
        window.location.href = (new URL(CHAT_EXCHANGE_URL)).origin + "/";

      } catch (err) {
        console.error(err);
        showError("Ошибка сети");
      }
    });
  </script>
</body>
</html>