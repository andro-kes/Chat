<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/chat.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card chat-container">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Чат</h4>
                        <button id="leaveBtn" class="btn btn-outline-secondary btn-sm">Покинуть</button>
                    </div>
                    <div class="card-body">
                        <div id="messages" class="messages-container"></div>
                    </div>
                    <div class="card-footer">
                        <form id="messageForm" class="d-flex">
                            <input type="text" id="messageInput" class="form-control" placeholder="Введите сообщение..." required>
                            <button type="submit" class="btn btn-primary ms-2">Отправить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roomID = '{{.room_id}}';
            const userID = '{{.user_id}}';
            
            // Получить токен из localStorage или других источников
            const token = localStorage.getItem('access_token') || getCookie('access_token');

            if (!token) {
                alert('Токен не найден');
                window.location.href = '/';
                return;
            }

            const wsProto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const socket = new WebSocket(
                `${wsProto}://${window.location.host}/ws/${roomID}?token=${encodeURIComponent(token)}`
            );


            const messagesContainer = document.getElementById('messages');
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const leaveBtn = document.getElementById('leaveBtn');

            // Обработчик получения сообщения
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const messageElement = document.createElement('div');
                messageElement.className = 'message mb-2';
                
                const senderName = data.sender_id === userID ? 'Вы' : data.sender_name || 'Пользователь';
                const isOwn = data.sender_id === userID;
                
                messageElement.innerHTML = `
                    <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="message-bubble ${isOwn ? 'own' : ''}">
                            <div class="message-content">${data.content}</div>
                            <div class="message-meta">
                                <span class="sender">${senderName}</span>
                                <span class="time">${new Date(data.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // Обработчик отправки сообщения
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (text) {
                    socket.send(JSON.stringify({text: text}));
                    messageInput.value = '';
                }
            });

            // Обработчик закрытия соединения
            socket.onclose = function(event) {
                console.log('Соединение закрыто', event);
                if (event.code !== 1000) { // 1000 = нормальное закрытие
                    alert('Соединение с чатом потеряно. Попробуйте перезагрузить страницу.');
                }
                window.location.href = '/';
            };

            socket.onerror = function(error) {
                console.error('Ошибка WebSocket:', error);
                alert('Произошла ошибка соединения с чатом.');
            };

            // Обработчик кнопки "Покинуть"
            leaveBtn.addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите покинуть чат?')) {
                    socket.close(1000, 'User left');
                }
            });

            // Загрузка истории сообщений
            loadMessages();

            function loadMessages() {
                fetch(`/api/${roomID}/messages`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.messages && Array.isArray(data.messages)) {
                            data.messages.forEach(msg => {
                                const messageElement = document.createElement('div');
                                messageElement.className = 'message mb-2';
                                
                                const senderName = msg.sender_id === userID ? 'Вы' : msg.sender_name || 'Пользователь';
                                const isOwn = msg.sender_id === userID;
                                
                                messageElement.innerHTML = `
                                    <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
                                        <div class="message-bubble ${isOwn ? 'own' : ''}">
                                            <div class="message-content">${msg.content}</div>
                                            <div class="message-meta">
                                                <span class="sender">${senderName}</span>
                                                <span class="time">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                messagesContainer.appendChild(messageElement);
                            });
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки сообщений:', error);
                    });
            }
        });
    </script>
</body>
</html>
